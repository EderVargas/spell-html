let palabras={},palabraActual="",palabrasUsadasPorNivel={},recognition=null,modo="oneStep",pasoMulti=0;function nuevaPalabraSinRepetir(){actualizarVisibilidadPalabra();let t=document.getElementById("difficulty").value;var e=palabras[t];e&&0!==e.length?(palabrasUsadasPorNivel[t]||(palabrasUsadasPorNivel[t]=[]),0===(e=e.filter(e=>!palabrasUsadasPorNivel[t].includes(e))).length?alert("Ya se usaron todas las palabras para este nivel. Reinicia si deseas comenzar de nuevo."):(palabraActual=e[Math.floor(Math.random()*e.length)],palabrasUsadasPorNivel[t].push(palabraActual),document.getElementById("wordDisplay").textContent=palabraActual,document.getElementById("resultText").textContent="",desHabilitaBotonesSpell(!1),speakWord(palabraActual))):alert("No hay palabras cargadas para este nivel.")}function reiniciarPalabrasUsadas(){document.getElementById("resultText").textContent="";var e=document.getElementById("difficulty").value;palabrasUsadasPorNivel[e]=[]}function iniciarEscucha(){var e;palabraActual?"webkitSpeechRecognition"in window||"SpeechRecognition"in window?(e=window.SpeechRecognition||window.webkitSpeechRecognition,(recognition=new e).lang="en-US",recognition.interimResults=!1,recognition.maxAlternatives=1,document.getElementById("startSpelling").textContent="üé§ Listening...",document.getElementById("resultText").textContent="üî° Spell and say the word (use 'capital', 'double', 'space')...",desHabilitaBotonesSpell(!0),recognition.onresult=function(e){var e=e.results[0][0].transcript.trim().toLowerCase(),{palabraInicial:t,deletreada:n,finalPalabra:a}=(console.log("Recognized:",e),interpretarSpellingConFinal(e)),o=palabraActual.toLowerCase().replace(/\s+/g,""),e=`<strong>üéß Heard:</strong> ${e}<br>`+`<strong>üî§ Inicial:</strong> ${t}<br>`+`<strong>üß© Spelled:</strong> ${n}<br>`+`<strong>üì£ Final:</strong> ${a}<br>`+(n===o&&(a===o&&t===o)?"‚úÖ <strong>Correcto!</strong>":"‚ùå <strong>Incorrecto.</strong>");document.getElementById("resultText").innerHTML=e,document.getElementById("startSpelling").textContent="üé§ Start Spelling",document.getElementById("wordDisplay").classList.remove("hidden"),desHabilitaBotonesSpell(!1)},recognition.onerror=function(e){console.error("Speech recognition error:",e.error),alert("Ocurri√≥ un error con el reconocimiento de voz. Intenta nuevamente."),desHabilitaBotonesSpell(!(document.getElementById("startSpelling").textContent="üé§ Start Spelling"))},recognition.onend=function(){"üé§ Listening..."===document.getElementById("startSpelling").textContent&&desHabilitaBotonesSpell(!(document.getElementById("startSpelling").textContent="üé§ Start Spelling"))},recognition.start()):alert("Tu navegador no soporta reconocimiento de voz."):alert("Primero genera una palabra para deletrear.")}function interpretarSpellingConFinal(e){var t=e.trim().split(/\s+/),e=t[0].toLowerCase();let n="",a=!1,o=!1,l=1;for(;l<t.length;l++){var r=t[l];if("capital"===r)a=!0;else if("space"===r)n+=" ";else if("double"===r)o=!0;else{if(!/^[a-z]$/i.test(r))break;r=a?r.toUpperCase():r.toLowerCase();n+=r,o&&(n+=r,o=!1),a=!1}}var i=t.slice(l).join("").toLowerCase();return{palabraInicial:e,deletreada:(n=n||i!==e?n:e).toLowerCase(),finalPalabra:i}}function desHabilitaBotonesSpell(e){document.getElementById("startSpelling").disabled=e,document.getElementById("speakAgain").disabled=e,document.getElementById("newWord").disabled=e,(document.getElementById("restartWord").disabled=e)?document.getElementById("stopListening").classList.remove("hidden"):document.getElementById("stopListening").classList.add("hidden")}function speakWord(e){actualizarVisibilidadPalabra();e=new SpeechSynthesisUtterance(e);e.lang="en-US",e.rate=.9,speechSynthesis.speak(e)}function actualizarVisibilidadPalabra(){var e=document.getElementById("showWordCheckbox");document.getElementById("wordDisplay").classList.toggle("hidden",!e.checked)}function onChangeMode(){modo=document.getElementById("modeSelect").value;var e=document.getElementById("oneStepButtons"),t=document.getElementById("stepSpellingBtn");"oneStep"===modo?(e.classList.remove("hidden"),t.classList.add("hidden")):(e.classList.add("hidden"),t.classList.remove("hidden"),pasoMulti=0,desHabilitaBotonesSpell(!(stepSpellingBtn.textContent="‚ñ∂Ô∏è Say Initial")),document.getElementById("resultText").textContent="")}function proximoPaso(){var e;palabraActual?"SpeechRecognition"in window||"webkitSpeechRecognition"in window?(e=window.SpeechRecognition||window.webkitSpeechRecognition,(recognition=new e).lang="en-US",recognition.interimResults=!1,recognition.maxAlternatives=1,document.getElementById("stepSpellingBtn").disabled=!0,document.getElementById("resultText").textContent=0===pasoMulti?"üó£Ô∏è Say the word first...":1===pasoMulti?"üî° Spell it now...":"üì£ Say the word again...",recognition.onresult=e=>{var t,n,a,e=e.results[0][0].transcript.trim().toLowerCase();0===pasoMulti?(document.getElementById("resultText").innerHTML="<strong>Initial:</strong> "+e,pasoMulti=1,stepSpellingBtn.textContent="üî§ Spell"):1===pasoMulti?(a=interpretarSpellingConFinal(e).deletreada,document.getElementById("resultText").innerHTML+="<br><strong>Spelled:</strong> "+a,pasoMulti=2,stepSpellingBtn.textContent="üì£ Final Word"):(document.getElementById("resultText").innerHTML+="<br><strong>Final:</strong> "+e,a=palabraActual.toLowerCase().replace(/\s+/g,""),t=e.split(/\s+/)[0]===palabraActual,n=interpretarSpellingConFinal(document.querySelector("#resultText").textContent).deletreada===a,e=e.replace(/\s+/g,"")===a,a=t&&n&&e,document.getElementById("resultText").innerHTML+="<br>"+(a?"‚úÖ Correct!":"‚ùå Incorrect."),pasoMulti=0,stepSpellingBtn.textContent="‚ñ∂Ô∏è Say Initial",document.getElementById("wordDisplay").classList.remove("hidden")),document.getElementById("stepSpellingBtn").disabled=!1,recognition=null},recognition.onerror=()=>{document.getElementById("resultText").textContent="‚ö†Ô∏è Error recognizing. Try again.",document.getElementById("stepSpellingBtn").disabled=!1,recognition=null},recognition.start()):alert("Tu navegador no soporta reconocimiento de voz."):alert("Primero genera una palabra para deletrear.")}fetch("assets/datos.json").then(e=>e.json()).then(e=>{palabras=e}).catch(e=>{console.error("Error al cargar palabras.json:",e),alert("No se pudieron cargar las palabras.")}),document.getElementById("stopListening").addEventListener("click",()=>{recognition&&(recognition.abort(),desHabilitaBotonesSpell(!(document.getElementById("startSpelling").textContent="üé§ Start Spelling")),document.getElementById("resultText").textContent="‚èπÔ∏è Escucha interrumpida.")}),window.addEventListener("DOMContentLoaded",onChangeMode);